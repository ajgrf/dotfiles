#!/bin/sh

trap 'exit 2' 2

if [ -f "${XDG_CONFIG_HOME:-$HOME/.config}/user-dirs.dirs" ]; then
	. "${XDG_CONFIG_HOME:-$HOME/.config}/user-dirs.dirs"
fi
XDG_DOWNLOAD_DIR="${XDG_DOWNLOAD_DIR:-$HOME/Downloads}"

# If no arguments are provided, try to find a link in the X selection.
if [ $# -eq 0 ] && [ -n "${selection:=$(xclip -out)}" ]; then
	set -- -- "$selection"
fi

# Display progress in console titlebar.
case "$TERM" in
xterm*|rxvt*|st*|screen*|tmux*)
	set_title="--console-title"
	;;
esac

# Continue downloads if provided with a JSON info file, else run youtube-dl
# normally.
for arg; do
	case "$arg" in
	*.info.json)
		(
			cd "$(dirname "$arg")"
			youtube-dl $set_title --load-info-json "${arg##*/}"
		)
		shift
		;;
	*)
		case "$PWD/" in
		"$XDG_DOWNLOAD_DIR/"*)
			:
			;;
		*)
			cd "$XDG_DOWNLOAD_DIR"
			;;
		esac

		exec youtube-dl $set_title "$@"
		;;
	esac
done
