#!/bin/sh
# backlightctl - wrapper to set the brightness on both of my displays.

usage() {
	echo "usage: backlightctl <percent>" >&2
	exit 2
}

main() {
	percent="${1%\%}"
	if test "$percent" -ge 0 -a "$percent" -le 100 2>/dev/null; then
		set_external_backlight "$percent"
		set_laptop_backlight "$percent"
	else
		usage
	fi
}

set_laptop_backlight() {
	# Send request to change backlight to GNOME Power Manager, falling back
	# to brightnessctl
	gdbus call --session --dest org.gnome.SettingsDaemon.Power \
		--object-path /org/gnome/SettingsDaemon/Power \
		--method org.freedesktop.DBus.Properties.Set \
		org.gnome.SettingsDaemon.Power.Screen Brightness "<int32 $1>" \
		>/dev/null || sudo brightnessctl -q -d intel_backlight set "${1}%"
}

set_external_backlight() {
	reload_ddcci && sudo brightnessctl -q -d ddcci1 set "${1}%"
}

# Reload DDC/CI kernel module if necessary
reload_ddcci() {
	test "$(xrandr -q | grep -c ' connected')" -eq 2 || return 1
	if ! brightnessctl -l -m | grep -q '^ddcci1,'; then
		sudo modprobe -r ddcci
		sudo modprobe ddcci
		sleep 1
	fi
}

main "$@"
